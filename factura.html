<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Factura Térmica Completa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* --- Estilos Anteriores (sin cambios) --- */
    * { box-sizing: border-box; font-family: 'Arial', sans-serif; }
    body { margin: 0; padding: 0; width: 80mm; background-color: #f0f0f0; display: flex; justify-content: center; }
    .factura { width: 80mm; padding: 10px 5px; background-color: #fff; }
    .header { text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #000; }
    .nombre-negocio { font-weight: bold; font-size: 16px; margin: 5px 0; letter-spacing: 0.5px; }
    .info-negocio { font-size: 11px; margin: 3px 0; line-height: 1.3; }
    .ncf-container { text-align: left; font-size: 14px; margin-top: 10px; font-weight: bold; }
    .numero-factura { font-weight: bold; text-align: left; margin: 10px 0; font-size: 14px; padding: 5px 0; border-top: 1px dashed #000; border-bottom: 1px dashed #000; }
    .ncf-validez { font-weight: normal; font-size: 11px; }
    .datos-factura, .total-row { display: flex; justify-content: space-between; margin: 6px 0; font-size: 12px; }
    .datos-cliente { margin: 12px 0; font-size: 12px; }
    .cliente-label { font-weight: bold; font-size: 13px; }
    .tipo-factura { text-align: center; margin: 12px 0; font-weight: bold; font-size: 14px; text-decoration: underline; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 12px; }
    table th { text-align: left; border-bottom: 1px solid #000; padding: 5px 3px; font-weight: bold; }
    table td { padding: 6px 3px; border-bottom: 1px dashed #ccc; }
    .totales { margin-top: 15px; border-top: 1px solid #000; padding-top: 10px; font-size: 13px; }
    .total-final { font-weight: bold; font-size: 14px; margin-top: 8px; }
    .firma-section { margin-top: 20px; padding-top: 10px; border-top: 1px dashed #000; }
    .firma-label { font-weight: bold; text-align: center; margin-bottom: 5px; font-size: 13px; }
    #firma-imagen { width: 100%; border: 1px solid #000; display: none; }
    #canvasFirma { width: 100%; height: 80px; border: 1px solid #000; margin: 0 auto; display: block; }
    .firma-texto { font-size: 10px; text-align: center; margin-top: 3px; font-style: italic; }
    .footer { margin-top: 15px; text-align: center; font-size: 10px; padding-top: 10px; border-top: 1px dashed #000; line-height: 1.4; }
    .print-button { width: 100%; padding: 10px; margin-top: 15px; background: #000; color: white; border: none; cursor: pointer; font-weight: bold; font-size: 14px; }
    
    /* --- NUEVOS ESTILOS PARA EL PANEL DE CONTROL --- */
    .panel-control {
        background-color: #f3f3f3;
        border: 1px solid #ddd;
        padding: 10px;
        margin-top: 20px;
    }
    .panel-control h4 {
        margin: 0 0 10px 0;
        font-size: 13px;
        text-align: center;
    }
    .panel-control input {
        width: 100%;
        padding: 5px;
        margin-bottom: 5px;
        border: 1px solid #ccc;
    }
    .panel-control button {
        width: 100%;
        padding: 8px;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
    }

    @media print {
      body { width: 80mm; margin: 0; padding: 0; background-color: #fff; }
      .factura { width: 80mm; padding: 5px; box-shadow: none; }
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>

<div class="factura">
  <div class="header">
    <div class="nombre-negocio">VIVELO TVG SRL</div>
    <div class="info-negocio">Av. San Vicente de Paul #112, Santo Domingo, Este</div>
    <div class="info-negocio">Tel: 829-905-0573 | RNC: 133261154</div>
  </div>
  <div class="ncf-container">
    <div>NCF: <span id="ncf-numero"></span></div>
    <div class="ncf-validez">VALIDO HASTA: 31/12/2025</div>
  </div>
  <div class="numero-factura">FACTURA: <span id="numero-factura"></span></div>
  <div class="datos-factura">
    <div><strong>Fecha:</strong> <span id="fecha"></span></div>
    <div><strong>Hora:</strong> <span id="hora"></span></div>
  </div>
  <div class="datos-cliente">
    <div class="cliente-label">CLIENTE:</div>
    <div id="cliente"></div>
  </div>
  <div class="tipo-factura">FACTURA CONSUMIDOR FINAL</div>
  <table>
    <thead>
      <tr>
        <th>Descripcion</th>
        <th style="text-align: right;">P. Unit.</th>
        <th style="text-align: right;">Cant.</th>
        <th style="text-align: right;">Subtotal</th> </tr>
    </thead>
    <tbody id="tablaProductos">
    </tbody>
  </table>
  <div class="totales">
    <div class="total-row">
      <span>Subtotal:</span>
      <span id="total-subtotal"></span>
    </div>
    <div class="total-row">
      <span>ITBIS (18%):</span>
      <span id="total-itbis"></span>
    </div>
    <div class="total-row total-final">
      <span>TOTAL GENERAL:</span>
      <span id="total-general"></span>
    </div>
  </div>
  <div class="firma-section">
    <div class="firma-label">FIRMA DEL CLIENTE</div>
    <div id="firma-container">
        <canvas id="canvasFirma" width="300" height="100"></canvas>
        <img id="firma-imagen" alt="Firma del cliente">
        <div class="firma-texto no-print">(Firme con el dedo o el mouse — Doble clic para borrar)</div>
    </div>
    <button id="guardar-firma-btn" class="print-button no-print" onclick="guardarFirma()">GUARDAR FIRMA</button>
    <div id="mensaje-firma" class="firma-texto no-print"></div>
  </div>
  <div class="footer">
    <div>Gracias por su compra!</div>
    <div>Todos nuestros articulos electronicos tienen 15 dias de garantia para cambio, no puede estar mojado, desalmado y debe tener los sellos de seguridad, debe presentar factura.</div>
  </div>
  <button class="print-button no-print" onclick="imprimirYActualizar()">IMPRIMIR FACTURA</button>

  <div class="panel-control no-print">
      <h4>Panel de Control de Numeración</h4>
      <label for="inputNcf">Próximo NCF:</label>
      <input type="number" id="inputNcf" placeholder="Ej: 150">
      <label for="inputFactura">Próxima Factura:</label>
      <input type="number" id="inputFactura" placeholder="Ej: 501">
      <button onclick="actualizarNumerosManualmente()">Actualizar Próximos Números</button>
  </div>
</div>

<script>
// --- FUNCIÓN PARA EL PANEL DE CONTROL (SIN CAMBIOS) ---
function actualizarNumerosManualmente() {
    const nuevoNcf = document.getElementById('inputNcf').value;
    const nuevaFactura = document.getElementById('inputFactura').value;

    if (nuevoNcf) {
        localStorage.setItem('ncfNumero', parseInt(nuevoNcf));
    }
    if (nuevaFactura) {
        localStorage.setItem('facturaNumero', parseInt(nuevaFactura));
    }

    if (nuevoNcf || nuevaFactura) {
        alert("¡Números actualizados! La página se recargará para mostrar los cambios.");
        location.reload();
    } else {
        alert("Por favor, ingrese al menos un número para actualizar.");
    }
}

document.addEventListener("DOMContentLoaded", function() {
  const params = new URLSearchParams(window.location.search);
  const cliente = params.get('cliente') || 'Consumidor final';
  
  // Lectura de totales de la URL (sin cambios)
  const totalGeneral = parseFloat(params.get('total')) || 0;
  const subtotalURL = parseFloat(params.get('subtotal')) || (totalGeneral / 1.18); 
  const itbisURL = parseFloat(params.get('itbis')) || (totalGeneral - subtotalURL); 
  
  const fechaParam = params.get('fecha');
  const fecha = fechaParam ? fechaParam.split(' ')[0] : new Date().toLocaleDateString('es-DO');
  const hora = new Date().toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' });
  
  let numeroFacturaActual = parseInt(localStorage.getItem('facturaNumero')) || 1;
  let numeroNcfActual = parseInt(localStorage.getItem('ncfNumero')) || 1;
  const numeroFacturaFormateado = String(numeroFacturaActual).padStart(6, '0');
  const ncfFormateado = 'B02' + String(numeroNcfActual).padStart(8, '0');
  
  // --- Asignaciones de encabezado y panel de control (sin cambios) ---
  document.getElementById('inputNcf').placeholder = `Próximo NCF (actual: ${numeroNcfActual})`;
  document.getElementById('inputFactura').placeholder = `Próxima Factura (actual: ${numeroFacturaActual})`;
  
  document.getElementById('numero-factura').textContent = numeroFacturaFormateado;
  document.getElementById('ncf-numero').textContent = ncfFormateado;
  document.getElementById('fecha').textContent = fecha;
  document.getElementById('hora').textContent = hora;
  document.getElementById('cliente').textContent = cliente;

  // --- MODIFICACIÓN CLAVE 2: Lógica para Múltiples Productos ---
  const tablaProductos = document.getElementById('tablaProductos');
  tablaProductos.innerHTML = ""; // Asegurar que esté vacío

  let i = 0;
  let productosEncontrados = false;
  // Iterar mientras se encuentre el parámetro p{i}
  while (params.has(`p${i}`)) {
      productosEncontrados = true;
      const datosProducto = params.get(`p${i}`).split('*');
      
      // La estructura enviada es: [0]Descripcion, [1]Cantidad, [2]PrecioUnitario, [3]ITBISIndividual
      const descripcion = decodeURIComponent(datosProducto[0] || 'Producto');
      const cantidad = parseFloat(datosProducto[1]) || 0;
      const precioUnitario = parseFloat(datosProducto[2]) || 0;
      // const itbisIndividual = parseFloat(datosProducto[3]) || 0; // No se usa para el cálculo del total de línea

      // CALCULO SOLICITADO: Subtotal del Ítem (P.Unit. * Cant.)
      const subtotalItem = (cantidad * precioUnitario);
      const totalItemMostrado = subtotalItem.toFixed(2); // Usamos el subtotal del ítem
      
      // Crear y llenar la nueva fila
      const nuevaFila = document.createElement('tr');
      nuevaFila.innerHTML = `
          <td>${descripcion}</td>
          <td style="text-align: right;">${precioUnitario.toFixed(2)}</td>
          <td style="text-align: right;">${cantidad}</td>
          <td style="text-align: right;">${totalItemMostrado}</td> `;
      
      tablaProductos.appendChild(nuevaFila);
      i++;
  }

  // Si no se encuentra ningún producto, añadir una fila por defecto
  if (!productosEncontrados) {
      tablaProductos.innerHTML = `
        <tr>
          <td>Producto no especificado</td>
          <td style="text-align: right;">0.00</td>
          <td style="text-align: right;">0</td>
          <td style="text-align: right;">0.00</td>
        </tr>`;
  }
  // --- FIN DE LÓGICA PARA MÚLTIPLES PRODUCTOS ---


  // --- ACTUALIZAR TOTALES CON LOS VALORES RECIBIDOS DE LA URL (sin cambios) ---
  document.getElementById('total-subtotal').textContent = `${subtotalURL.toFixed(2)} RD$`;
  document.getElementById('total-itbis').textContent = `${itbisURL.toFixed(2)} RD$`;
  document.getElementById('total-general').textContent = `${totalGeneral.toFixed(2)} RD$`;
  
  // --- El resto del script para la firma, etc., sigue igual ---
  const canvas = document.getElementById("canvasFirma");
  const ctx = canvas.getContext("2d");
  const firmaImagen = document.getElementById("firma-imagen");
  const guardarBtn = document.getElementById("guardar-firma-btn");
  const firmaGuardada = sessionStorage.getItem('firmaCliente');

  if (firmaGuardada) {
    firmaImagen.src = firmaGuardada;
    firmaImagen.style.display = 'block';
    canvas.style.display = 'none';
    guardarBtn.style.display = 'none';
    document.querySelector('.firma-texto').style.display = 'none';
  }

  const ratio = window.devicePixelRatio || 1;
  canvas.width = canvas.offsetWidth * ratio;
  canvas.height = canvas.offsetHeight * ratio;
  canvas.style.width = canvas.offsetWidth + "px";
  canvas.style.height = canvas.offsetHeight + "px";
  ctx.scale(ratio, ratio);
  let dibujando = false;

  function obtenerPosicion(e) {
    const rect = canvas.getBoundingClientRect();
    const evt = e.touches ? e.touches[0] : e;
    return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
  }
  function comenzarDibujo(e) {
    dibujando = true;
    const pos = obtenerPosicion(e);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
    e.preventDefault();
  }
  function terminarDibujo(e) {
    dibujando = false;
    ctx.closePath();
    e.preventDefault();
  }
  function dibujar(e) {
    if (!dibujando) return;
    const pos = obtenerPosicion(e);
    ctx.lineTo(pos.x, pos.y);
    ctx.lineWidth = 1.8;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    ctx.stroke();
    e.preventDefault();
  }
  
  canvas.addEventListener("mousedown", comenzarDibujo);
  canvas.addEventListener("mousemove", dibujar);
  canvas.addEventListener("mouseup", terminarDibujo);
  canvas.addEventListener("mouseleave", terminarDibujo);
  canvas.addEventListener("touchstart", comenzarDibujo);
  canvas.addEventListener("touchmove", dibujar);
  canvas.addEventListener("touchend", terminarDibujo);
  canvas.addEventListener("dblclick", () => ctx.clearRect(0, 0, canvas.width, canvas.height));
});

function guardarFirma() {
  const canvas = document.getElementById("canvasFirma");
  const dataURL = canvas.toDataURL("image/png");
  sessionStorage.setItem('firmaCliente', dataURL);
  document.getElementById("mensaje-firma").innerText = "Firma guardada correctamente.";
  document.getElementById("mensaje-firma").style.color = "green";
  const firmaImagen = document.getElementById("firma-imagen");
  firmaImagen.src = dataURL;
  firmaImagen.style.display = 'block';
  canvas.style.display = 'none';
  document.getElementById("guardar-firma-btn").style.display = 'none';
}

function imprimirYActualizar() {
  window.print();
  let proximoNumeroFactura = (parseInt(localStorage.getItem('facturaNumero')) || 1) + 1;
  let proximoNcf = (parseInt(localStorage.getItem('ncfNumero')) || 1) + 1;
  localStorage.setItem('facturaNumero', proximoNumeroFactura);
  localStorage.setItem('ncfNumero', proximoNcf);
}
</script>

</body>
</html>